<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Market</title>
    <link rel = "stylesheet" href = "main-page.css">
</head>
<body onload = "getAllTickers()">
    <div id = "header">
        <h1>Stock Market</h1>
        <h2>Invest for success.</h2>
    </div>
    <div id = "tickers">
        <h3>Filter by...</h3>
        <div id = "filter-market-cap-div">
            <h4 id = "filter-market-cap">Market Capitalization</h4>
            <input id = "new-filter-input-market-cap" type = "number">
            <button id = "new-filter-button-market-cap" onclick = "getFilteredMarketCapTickers()">Filter!</button>
        </div>
        <div id = "filter-amount-stocks-div">
            <h4 id = "filter-amount-stocks">Amount of Stocks</h4>
            <input id = "new-filter-input-amount-stocks" type = "number">
            <button id = "new-filter-button-amount-stocks" onclick = "getFilteredAmountStocksTickers()">Filter!</button>
        </div>
        <div id = "filter-price-per-stock-div">
            <h4 id = "filter-price-per-stock">Price per Stock</h4>
            <input id = "new-filter-input-price-per-stock" type = "number">
            <button id = "new-filter-button-filter-price-per-stock" onclick = "getFilteredPricePerStockTickers()">Filter!</button>
        </div>
        <button id = "remove-filters" onclick = "removeFilters()">Remove All Filters</button>
        <table id = "dynamic-ticker">
            <thead id = "dynamic-ticker-head">
                <th>ID</th>
                <th>Ticker</th>
                <th>Market Capitalization</th>
                <th>Amount of Stocks</th>
                <th>Price Per Stock</th>
            </thead>
            <tbody id = "dynamic-ticker-body"></tbody>
        </table>
        <input id = "specific-company-input" type = "text" placeholder = "Enter a ticker">
        <button id = "specific-company-button" onclick = "getSpecificCompany()">Look up a company</button>
    </div>
    <div id = "main">
        <div id = "company-info">
            <table id = "company-table">
                <thead id = "company-table-head"></thead>
                <tbody id = "company-table-body"></tbody>
            </table>
        </div>
        <div id = "buy-stock">
            <h2>Invest</h2>
            <label id = "label-buy-company-id">Id</label>
            <br>
            <input type = "number" id = "buy-company-id">
            <br>
            <label id = "buy-amount" min = "1">Amount of Stocks to Buy:</label>
            <br>
            <input type = "number" id = "enter-amount-stocks">
            <br>
            <label id = "buy-price" min = "1">Buying Price:</label>
            <br>
            <input type = "number" id = "enter-buying-price">
            <br>
            <h3 id = "buy-total"></h3>
            <div id = "new-price-per-stock">
                <h4>New Price Per Stock:</h4>
            </div>
            <div id = "new-market-cap-est">
                <h4>New Market Capitalization:</h4>
            </div>
            <button onclick = "showNewEstimates()">Get new estimate</button>
            <button id = "purchase-stock" onclick = "buyStocks()">Purchase</button>
        </div>
    </div>
</body>
<script>
    /*

        Necessary Functions:
            - (DONE) Pull up the tickers of all companies (an async await function)
            - (DONE) When the filter's new submit button is clicked, it should pull up the tickers of all companies that meet those criteria
            - When you click on a ticker, it should load that specific company on the page
            - When you purchase a stock, it should have a pop up confirmation to purchase, and if ok reload the page and that'll have the refreshed numbers

        Pretty Functions:
            - Make the ticker change colors when you hover over it 
            - Buttons change color when you hover on and off of it
            - Add fun pretty elements when done with hard stufff

    */

    // function to get all tickers
    const tickerTable = document.getElementById("dynamic-ticker");
    const tableHead = document.getElementById("dynamic-ticker-head");
    const tableBody = document.getElementById("dynamic-ticker-body");

    async function getAllTickers(){
        let httpResponse = await fetch("http://localhost:8080/tickers");
        console.log(httpResponse);
        let responseBody = await httpResponse.json();
        console.log(responseBody);
        
        if(httpResponse.status === 200){
            for(x of responseBody){
                let tr = document.createElement("tr");
                tr.innerHTML = 
                `
                    <td id = "original-id-${x.id}">${x.id}</td>
                    <td id = "original-ticker-${x.id}">${x.ticker}</td>
                    <td id = "original-market-cap-${x.id}">${x.market_cap}</td>
                    <td id = "original-amount-${x.id}">${x.amount_stocks}</td>
                    <td id = "original-price-per-stock-${x.id}">${x.price_per_stock}</td>
                `;
                tableBody.appendChild(tr);
            }
        } else {
            alert("The stock market has crashed.");
        }
    }

    async function removeFilters(){
        let httpResponse = await fetch("http://localhost:8080/tickers");
        console.log(httpResponse);
        let responseBody = await httpResponse.json();
        console.log(responseBody);
        
        if(httpResponse.status === 200){
            for(x of responseBody){
                let tr = document.createElement("tr");
                tr.innerHTML = 
                `
                    <td id = "original-id-${x.id}">${x.id}</td>
                    <td id = "original-ticker-${x.id}">${x.ticker}</td>
                    <td id = "original-market-cap-${x.id}">${x.market_cap}</td>
                    <td id = "original-amount-${x.id}">${x.amount_stocks}</td>
                    <td id = "original-price-per-stock-${x.id}">${x.price_per_stock}</td>
                `;
                tableBody.appendChild(tr);
            }
        } else {
            alert("The stock market has crashed.");
        }
    }

    const dynamicTicker = document.getElementById("dynamic-ticker");

    // function for making filtered by market cap tickers pop up
    const newFilterInputMarketCap = document.getElementById("new-filter-input-market-cap");

    async function getFilteredMarketCapTickers(){
        let httpResponse = await fetch(`http://localhost:8080/marketcap/${newFilterInputMarketCap.value}`);
        console.log(httpResponse);
        let responseBody = await httpResponse.json();
        console.log(responseBody);
        
        tableBody.innerHTML = "";

        if(newFilterInputMarketCap.value <= 0){
            alert("Please choose a market cap to filter by.")
        }    

        if(httpResponse.status === 200){
            for(x of responseBody){
                let tr = document.createElement("tr");
                tr.innerHTML = 
                `
                    <td id = "original-id-${x.id}">${x.id}</td>
                    <td id = "original-ticker-${x.id}">${x.ticker}</td>
                    <td id = "original-market-cap-${x.id}">${x.market_cap}</td>
                    <td id = "original-amount-${x.id}">${x.amount_stocks}</td>
                    <td id = "original-price-per-stock-${x.id}">${x.price_per_stock}</td>
                `;
                tableBody.appendChild(tr);
            }
        } else {
            alert("The stock market has crashed.");
        }
    }

    // function for making filtered by amount of stocks tickers pop up
    const newFilterInputAmountStocks = document.getElementById("new-filter-input-amount-stocks");
    
    async function getFilteredAmountStocksTickers(){
        let httpResponse = await fetch(`http://localhost:8080/amountstocks/${newFilterInputAmountStocks.value}`);
        console.log(httpResponse);
        let responseBody = await httpResponse.json();
        console.log(responseBody);
        
        tableBody.innerHTML = "";

        if(newFilterInputAmountStocks.value <= 0){
            alert("Please choose an amount of stocks to filter by.")
        }    

        if(httpResponse.status === 200){
            for(x of responseBody){
                let tr = document.createElement("tr");
                tr.innerHTML = 
                `
                    <td id = "original-id-${x.id}">${x.id}</td>
                    <td id = "original-ticker-${x.id}">${x.ticker}</td>
                    <td id = "original-market-cap-${x.id}">${x.market_cap}</td>
                    <td id = "original-amount-${x.id}">${x.amount_stocks}</td>
                    <td id = "original-price-per-stock-${x.id}">${x.price_per_stock}</td>
                `;
                tableBody.appendChild(tr);
            }
        } else {
            alert("The stock market has crashed.");
        }
    }

    // function for making filtered by price per stock tickers pop up
    const newFilterInputPricePerStock = document.getElementById("new-filter-input-price-per-stock");
    
    async function getFilteredPricePerStockTickers(){
        let httpResponse = await fetch(`http://localhost:8080/priceperstock/${newFilterInputPricePerStock.value}`);
        console.log(httpResponse);
        let responseBody = await httpResponse.json();
        console.log(responseBody);
        
        tableBody.innerHTML = "";

        if(newFilterInputPricePerStock.value <= 0){
            alert("Please choose a price per stock to filter by.")
        }    

        if(httpResponse.status === 200){
            for(x of responseBody){
                let tr = document.createElement("tr");
                tr.innerHTML = 
                `
                    <td id = "original-id-${x.id}">${x.id}</td>
                    <td id = "original-ticker-${x.id}">${x.ticker}</td>
                    <td id = "original-market-cap-${x.id}">${x.market_cap}</td>
                    <td id = "original-amount-${x.id}">${x.amount_stocks}</td>
                    <td id = "original-price-per-stock-${x.id}">${x.price_per_stock}</td>
                `;
                tableBody.appendChild(tr);
            }
        } else {
            alert("The stock market has crashed.");
        }
    }

    const companyTable = document.getElementById("company-table");
    const companyTableHead = document.getElementById("company-table-head");
    const companyTableBody = document.getElementById("company-table-body");
    const specificCompanyInput = document.getElementById("specific-company-input");

    async function getSpecificCompany(){       
        let httpResponse = await fetch(`http://localhost:8080/company/${specificCompanyInput.value}`);
        console.log(httpResponse);
        let responseBody = await httpResponse.json();

        if(httpResponse.status === 200){
            console.log(responseBody);

            for(x of responseBody.searchResult){
                let tr = document.createElement("tr");
                tr.innerHTML = 
                `
                <td id = "id-${x.id}">${x.id}</td>
                <td id = "company-name-${x.id}">${x.company_name}</td>
                <td id = "ticker-${x.id}">${x.ticker}</td>
                <td id = "description-${x.id}">${x.description}</td>
                <td id = "image-url-${x.id}"><img src="${x.image_url}" alt="Company Image" width="400" height="400"></td>
                <td id = "amount-stocks-${x.id}">${x.amount_stocks}</td>
                <td id = "price-per-stock-${x.id}">${x.price_per_stock}</td>
                <td id = "market-cap-${x.id}">${x.market_cap}</td>
                `
                companyTableBody.appendChild(tr);
            }
        } else {
            alert("This company has gone bankrupt!");
        }
    }

    // function to update stocks
    const buyAmount = document.getElementById("enter-amount-stocks");
    const buyPrice = document.getElementById("enter-buying-price");
    const newMarketCap = buyAmount.value * buyPrice.value;
    const buyCompanyId = document.getElementById("buy-company-id");
    const buyCompanyName = document.getElementById("buy-company-name");

    const newMarketCapEstDiv = document.getElementById("new-market-cap-est");
    const newPriceEstDiv = document.getElementById("new-price-per-stock");
    const seeNewEstimatesButton = document.getElementById("see-new-estimates");

    function showNewEstimates(){  // make sure to add an if loop that if the buyAmount of stocks is larger than originalAmount of stocks, an error message will pop up
        var originalAmount = document.getElementById(`original-amount-${buyCompanyId.value}`.innerHTML);
        var originalPrice = document.getElementById(`original-price-per-stock-${buyCompanyId.value}`.innerHTML);
        let necessaryMCDecimal = (buyAmount.value * buyPrice.value)/(buyAmount.value * originalPrice);
        let buyMoney = (buyAmount.value * buyPrice.value);
        let ogMC = (originalAmount * originalPrice);
        let newMC = 0;

        console.log(`Original Amount: ${originalAmount}`)
        console.log(`Original Price: ${originalPrice}`)
        console.log(`necessaryMCDecimal: ${necessaryMCDecimal}`)
        console.log(`buyMoney: ${buyMoney}`)
        console.log(`ogMC: ${ogMC}`)
        console.log(`buyAmount: ${buyAmount.value}`)
        console.log(`buyPrice: ${buyPrice.value}`)

        // this finds the new market cap
        if(necessaryMCDecimal >= 1){
            newMC = ogMc + buyMoney
        } else if(necessaryMCDecimal <= 1){
            newMC = ogMc - buyMoney
        }
        
        // this finds the new price per stock
        let newPricePerStock = newMC/originalAmount.value

        let resultMC = newMC;
        let resultPPS = newPricePerStock;
        console.log(`newMC: ${newMC}`)
        console.log(`resultMC: ${resultMC}`);
        console.log(`resultPPS: ${resultPPS}`);

        // need to append these values into the html
        let h5MC = document.createElement("h5");
            h5MC.innerHTML = resultMC;
            h5MC.id = "new-market-capitalization-estimate";
            newMarketCapEstDiv.appendChild(h5MC);


        let h5PPS = document.createElement("h5");
            h5PPS.innerHTML = resultPPS;
            h5PPS.id = "new-price-per-stock-estimate";
            newPriceEstDiv.appendChild(h5PPS);
    }

    async function buyStocks(){
        let updateInfo = {
            ...updateInfo,  // by using the spread operator here, it is keeping all of my original values. then the new attributes below are just updating what i want
            price_per_stock: document.getElementById("new-price-per-stock-estimate").textContent,
            market_cap: document.getElementById("new-market-capitalization-estimate").textContent
        };

        let updateJSON = JSON.stringify(updateInfo);

        let config = {
            method: "PATCH",
            headers: {'Content-Type': "application/json"},
            body: updateJSON
        }

        let httpResponse = await fetch(`http://localhost:8080/company/${buyCompanyId.value}`, config);
        console.log(httpResponse.status);

        if(httpResponse.status === 200){
            if(buyCompanyId.value === 0){
                alert("Please choose a company to invest in.")
            } else if(buyAmount.value === 0){
                alert("Please choose an amount of stocks to purchase.")
            } else if(buyPrice.value === 0){
                alert("Please choose a price to pay per stock")
            } else {
                alert("Thank you for your investment!")
            }
        }
    }

</script>
</html>